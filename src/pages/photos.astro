---
import { getCollection } from "astro:content";
import { SITE } from "@config";
import Layout from "@layouts/Layout.astro";
import Main from "@layouts/Main.astro";
import Header from "@components/Header.astro";
import Footer from "@components/Footer.astro";
import PhotoGallery from "../components/PhotoGallery.jsx";
import fs from "fs";
import path from "path";

// 定义 getSortedPosts 函数
function getSortedPosts(posts) {
  return posts.sort((a, b) => new Date(b.data.date) - new Date(a.data.date));
}

// Retrieve all published articles
const posts = await getCollection("blog", ({ data }) => !data.draft);
const sortedPosts = getSortedPosts(posts);

// List of photos to display in the album
const initialPhotos = sortedPosts.map(({ data, slug }) => ({
  src: data.image, // Assuming each post has an image field
  width: data.imageWidth, // Assuming each post has an imageWidth field
  height: data.imageHeight, // Assuming each post has an imageHeight field
  title: data.title,
  description: data.description,
}));

// Read images from public/imgs directory
const publicImgsDir = path.join(process.cwd(), "public", "imgs");
const imageFiles = fs.readdirSync(publicImgsDir).filter((file) => file.match(/\.(jpg|jpeg|png|gif)$/i));
const publicPhotos = imageFiles.map((file) => ({
  src: `/imgs/${file}`,
  width: 800, // Assuming a default width
  height: 600, // Assuming a default height
  title: file,
  description: `Image: ${file}`,
}));

const photos = [...initialPhotos, ...publicPhotos];

---

<Layout title={`Photo Album | ${SITE.title}`}>
  <Header activeNav="photo-album" />
  <Main pageTitle="Photo Album" pageDesc="View our photo album ...">
    <PhotoGallery photos={photos} />
  </Main>
  <Footer />
</Layout>
